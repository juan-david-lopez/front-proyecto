// utils/apiTester.ts
/**
 * Utilidad para testing manual de la integraci√≥n Frontend-Backend
 * Usar en DevTools Console del navegador
 */

class ApiTester {
  private baseURL: string;
  private token: string | null;

  constructor() {
    this.baseURL = this.getBaseURL();
    this.token = localStorage.getItem('accessToken');
    console.log('üîß ApiTester inicializado');
    console.log('üì° Base URL:', this.baseURL);
    console.log('üîê Token:', this.token ? '‚úÖ Presente' : '‚ùå No encontrado');
  }

  private getBaseURL(): string {
    if (process.env.NEXT_PUBLIC_API_URL) return process.env.NEXT_PUBLIC_API_URL;
    if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
      return 'http://localhost:8080';
    }
    return 'https://desplieguefitzone.onrender.com';
  }

  private async request(endpoint: string, options: RequestInit = {}) {
    const url = `${this.baseURL}/api/v1${endpoint}`;
    
    const defaultHeaders = {
      'Content-Type': 'application/json',
      ...(this.token && { 'Authorization': `Bearer ${this.token}` })
    };

    const config: RequestInit = {
      ...options,
      headers: {
        ...defaultHeaders,
        ...options.headers
      }
    };

    console.log(`üîÑ ${config.method || 'GET'} ${url}`);
    console.log('üì¶ Headers:', config.headers);
    
    if (config.body) {
      console.log('üì¶ Body:', config.body);
    }

    try {
      const response = await fetch(url, config);
      const contentType = response.headers.get('content-type');
      
      let data;
      if (contentType && contentType.includes('application/json')) {
        data = await response.json();
      } else {
        data = await response.text();
      }

      if (response.ok) {
        console.log(`‚úÖ ${response.status} ${response.statusText}`);
        console.log('üì¶ Response:', data);
        return { success: true, status: response.status, data };
      } else {
        console.error(`‚ùå ${response.status} ${response.statusText}`);
        console.error('üì¶ Error:', data);
        return { success: false, status: response.status, error: data };
      }
    } catch (error) {
      console.error('üí• Network Error:', error);
      return { 
        success: false, 
        error: error instanceof Error ? error.message : 'Unknown error' 
      };
    }
  }

  // ======================
  // TESTING DE ENDPOINTS
  // ======================

  // Health Check
  async testHealth() {
    console.log('\nüè• Testing Health Check...');
    return await this.request('/health');
  }

  // Autenticaci√≥n
  async testLogin(email: string, password: string) {
    console.log('\nüîê Testing Login...');
    return await this.request('/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password })
    });
  }

  // Recibos
  async testCreateReceipt(receiptData: any) {
    console.log('\nüßæ Testing Create Receipt...');
    return await this.request('/receipts', {
      method: 'POST',
      body: JSON.stringify(receiptData)
    });
  }

  async testGetUserReceipts(userId: string) {
    console.log('\nüßæ Testing Get User Receipts...');
    return await this.request(`/users/${userId}/receipts`);
  }

  async testGetReceiptById(receiptId: string) {
    console.log('\nüßæ Testing Get Receipt By ID...');
    return await this.request(`/receipts/${receiptId}`);
  }

  // Notificaciones
  async testGetNotifications(userId: string) {
    console.log('\nüîî Testing Get Notifications...');
    return await this.request(`/notifications/${userId}`);
  }

  async testCreateNotification(notificationData: any) {
    console.log('\nüîî Testing Create Notification...');
    return await this.request('/notifications', {
      method: 'POST',
      body: JSON.stringify(notificationData)
    });
  }

  async testMarkAsRead(notificationId: string) {
    console.log('\nüîî Testing Mark Notification as Read...');
    return await this.request(`/notifications/${notificationId}/read`, {
      method: 'PATCH'
    });
  }

  // Auto-Renovaci√≥n
  async testGetAutoRenewalPreferences(userId: string) {
    console.log('\nüîÑ Testing Get Auto-Renewal Preferences...');
    return await this.request(`/users/${userId}/membership/auto-renewal-preferences`);
  }

  async testUpdateAutoRenewalPreferences(userId: string, preferences: any) {
    console.log('\nüîÑ Testing Update Auto-Renewal Preferences...');
    return await this.request(`/users/${userId}/membership/auto-renewal-preferences`, {
      method: 'PUT',
      body: JSON.stringify(preferences)
    });
  }

  async testCheckExpiration(userId: string) {
    console.log('\nüîÑ Testing Check Expiration...');
    return await this.request(`/users/${userId}/membership/check-expiration`);
  }

  async testProcessAutoRenewal(userId: string) {
    console.log('\nüîÑ Testing Process Auto-Renewal...');
    return await this.request(`/users/${userId}/membership/auto-renew`, {
      method: 'POST'
    });
  }

  // Reportes Administrativos
  async testGetKPIs(period = 'monthly') {
    console.log('\nüìä Testing Get KPIs...');
    return await this.request(`/admin/reports/kpis?period=${period}`);
  }

  async testGetRevenueReport(period = 'monthly') {
    console.log('\nüìä Testing Get Revenue Report...');
    return await this.request(`/admin/reports/revenue?period=${period}`);
  }

  async testGetMembershipStats() {
    console.log('\nüìä Testing Get Membership Stats...');
    return await this.request('/admin/reports/memberships');
  }

  async testGetPaymentMethodStats() {
    console.log('\nüìä Testing Get Payment Method Stats...');
    return await this.request('/admin/reports/payment-methods');
  }

  async testGetRenewalStats() {
    console.log('\nüìä Testing Get Renewal Stats...');
    return await this.request('/admin/reports/renewals');
  }

  async testGetDashboard() {
    console.log('\nüìä Testing Get Admin Dashboard...');
    return await this.request('/admin/reports/dashboard');
  }

  // ===================
  // TESTS INTEGRALES
  // ===================

  async runBasicTests(userId: string) {
    console.log('\nüöÄ Ejecutando tests b√°sicos...');
    
    const results = {
      health: await this.testHealth(),
      receipts: await this.testGetUserReceipts(userId),
      notifications: await this.testGetNotifications(userId),
      autoRenewal: await this.testGetAutoRenewalPreferences(userId)
    };

    console.log('\nüìä Resumen de tests b√°sicos:');
    Object.entries(results).forEach(([test, result]) => {
      const status = result.success ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${test}: ${result.status || 'Error'}`);
    });

    return results;
  }

  async runAdminTests() {
    console.log('\nüëë Ejecutando tests de admin...');
    
    const results = {
      kpis: await this.testGetKPIs(),
      revenue: await this.testGetRevenueReport(),
      memberships: await this.testGetMembershipStats(),
      paymentMethods: await this.testGetPaymentMethodStats(),
      renewals: await this.testGetRenewalStats(),
      dashboard: await this.testGetDashboard()
    };

    console.log('\nüìä Resumen de tests de admin:');
    Object.entries(results).forEach(([test, result]) => {
      const status = result.success ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${test}: ${result.status || 'Error'}`);
    });

    return results;
  }

  async runFullIntegrationTest(userId: string) {
    console.log('\nüéØ Ejecutando test completo de integraci√≥n...');
    
    // Test 1: Health
    const health = await this.testHealth();
    if (!health.success) {
      console.error('üí• Backend no disponible. Abortando tests.');
      return;
    }

    // Test 2: Datos b√°sicos
    const basic = await this.runBasicTests(userId);
    
    // Test 3: Crear datos de prueba
    console.log('\nüß™ Creando datos de prueba...');
    
    const testReceipt = await this.testCreateReceipt({
      userId,
      transactionType: 'MEMBERSHIP_PAYMENT',
      amount: 250000,
      paymentMethod: 'CREDIT_CARD',
      membershipType: 'PREMIUM',
      membershipDuration: 30,
      notes: 'Test receipt from ApiTester'
    });

    const testNotification = await this.testCreateNotification({
      userId,
      type: 'EXPIRATION_WARNING',
      priority: 'HIGH',
      title: 'Test Notification',
      message: 'This is a test notification from ApiTester'
    });

    // Test 4: Admin (si tienes permisos)
    const admin = await this.runAdminTests();

    console.log('\nüéâ Test completo finalizado!');
    
    return {
      health,
      basic,
      testReceipt,
      testNotification,
      admin
    };
  }

  // =================
  // DATOS DE PRUEBA
  // =================

  getSampleReceiptData(userId: string) {
    return {
      userId,
      transactionType: 'MEMBERSHIP_PAYMENT',
      amount: 250000,
      tax: 47500,
      total: 297500,
      paymentMethod: 'CREDIT_CARD',
      membershipType: 'PREMIUM',
      membershipDuration: 30,
      notes: 'Pago de membres√≠a Premium - Testing'
    };
  }

  getSampleNotificationData(userId: string) {
    return {
      userId,
      type: 'EXPIRATION_WARNING',
      priority: 'HIGH',
      title: 'Tu membres√≠a est√° por vencer',
      message: 'Tu membres√≠a Premium vence en 7 d√≠as. Renueva ahora para mantener tus beneficios.',
      metadata: {
        daysUntilExpiry: 7,
        membershipType: 'PREMIUM'
      }
    };
  }

  getSampleAutoRenewalPreferences() {
    return {
      enabled: true,
      notificationDays: 7,
      paymentMethod: 'CREDIT_CARD'
    };
  }

  // ================
  // UTILIDADES
  // ================

  refreshToken() {
    this.token = localStorage.getItem('accessToken');
    console.log('üîÑ Token actualizado:', this.token ? '‚úÖ Presente' : '‚ùå No encontrado');
  }

  setCustomToken(token: string) {
    this.token = token;
    localStorage.setItem('accessToken', token);
    console.log('üîê Token personalizado configurado');
  }

  clearToken() {
    this.token = null;
    localStorage.removeItem('accessToken');
    console.log('üóëÔ∏è Token eliminado');
  }

  showInstructions() {
    console.log(`
üîß ApiTester - Instrucciones de Uso

üìã Configuraci√≥n:
   const tester = new ApiTester();

üîê Autenticaci√≥n:
   await tester.testLogin('user@fitzone.com', 'password123');
   tester.refreshToken(); // Actualizar token despu√©s del login

üß™ Tests individuales:
   await tester.testHealth();
   await tester.testGetUserReceipts('user-id');
   await tester.testCreateReceipt(tester.getSampleReceiptData('user-id'));

üöÄ Tests completos:
   await tester.runBasicTests('user-id');
   await tester.runAdminTests();
   await tester.runFullIntegrationTest('user-id');

üìä Datos de prueba:
   tester.getSampleReceiptData('user-id');
   tester.getSampleNotificationData('user-id');
   tester.getSampleAutoRenewalPreferences();

üîß Utilidades:
   tester.refreshToken();
   tester.setCustomToken('your-jwt-token');
   tester.clearToken();
    `);
  }
}

// Hacer disponible globalmente para uso en console
if (typeof window !== 'undefined') {
  (window as any).ApiTester = ApiTester;
  (window as any).apiTester = new ApiTester();
  
  console.log('üéâ ApiTester cargado!');
  console.log('üí° Usa "apiTester" en console o crea nueva instancia: new ApiTester()');
  console.log('üìñ Para ver instrucciones: apiTester.showInstructions()');
}

export default ApiTester;